# Архитектура данных CPA-кампаний

## 1. Общая схема

Данные хранятся в **PostgreSQL**. Поток событий приходит из **Kafka**, обрабатывается микросервисами и записывается в БД. Для аналитики используются предагрегированные срезы по дням.

Основные таблицы:
- `campaigns` — справочник кампаний.
- `campaign_performance_events` — журнал сырых событий.
- `campaign_metric_dailies` — агрегированные метрики по дням (обновлённое имя таблицы).

## 2. Структура таблиц (с учётом изменённых типов)

### 2.1. `campaigns`

| Поле         | Тип                | Описание                                |
|--------------|--------------------|-----------------------------------------|
| `id`         | `BIGINT` PK        | Идентификатор кампании                  |
| `name`       | `VARCHAR(255)`     | Имя кампании                            |
| `ad_group_id`| `BIGINT` NULL      | Связь с группой объявлений              |
| `campaign_type` | `VARCHAR(32)`   | Тип кампании: `display/search/video`    |
| `status`     | `VARCHAR(32)`      | Статус: `active/paused/completed`       |
| `created_at` | `TIMESTAMPTZ`      | Время создания                          |
| `updated_at` | `TIMESTAMPTZ`      | Время последнего обновления             |

Индексы:
- `idx_campaign_status` (`status`)
- `idx_campaign_ad_group` (`ad_group_id`)

> Примечание: вместо ENUM используются строковые поля; допустимые значения контролируются приложением и/или CHECK-ограничениями (если настроены).

---

### 2.2. `campaign_performance_events`

| Поле         | Тип                | Описание                                                     |
|--------------|--------------------|--------------------------------------------------------------|
| `id`         | `BIGINT` PK        | Идентификатор события                                       |
| `campaign_id`| `BIGINT` FK        | Ссылка на `campaigns(id)`                                   |
| `event_type` | `VARCHAR(32)`      | `conversion/click/impression/purchase`                      |
| `event_time` | `TIMESTAMPTZ`      | Время события                                               |
| `user_id`    | `BIGINT` NULL      | Идентификатор пользователя (опционально)                    |
| `value`      | `DECIMAL(10,4)`    | Стоимость/ценность события (опционально)                    |
| `currency`   | `VARCHAR(3)` NULL  | Валюта (ISO 4217), опционально                              |
| `metadata`   | `JSONB` NULL       | Дополнительные атрибуты события (устройство, товар и т.п.)  |
| `created_at` | `TIMESTAMPTZ`      | Время записи                                                |
| `updated_at` | `TIMESTAMPTZ`      | Время обновления                                            |

Индексы:
- `idx_campaign_event` (`campaign_id`, `event_type`)
- `idx_event_time` (`event_time`)
- `idx_event_type` (`event_type`)

---

### 2.3. `campaign_metric_dailies`

| Поле                      | Тип             | Описание                                   |
|---------------------------|-----------------|--------------------------------------------|
| `id`                      | `BIGINT` PK     | Идентификатор строки                       |
| `campaign_id`             | `BIGINT` FK     | Ссылка на `campaigns(id)`                  |
| `date`                    | `DATE`          | Дата (день)                                |
| `cpa`                     | `DECIMAL(10,4)` | Cost Per Acquisition                       |
| `ctr`                     | `DECIMAL(5,4)`  | Click-Through Rate                          |
| `conversion_rate`         | `DECIMAL(5,4)`  | Доля конверсий                              |
| `revenue_per_conversion`  | `DECIMAL(10,4)` | Средняя выручка на конверсию                |
| `total_conversions`       | `INTEGER`       | Количество конверсий                        |
| `total_clicks`            | `INTEGER`       | Количество кликов                           |
| `total_impressions`       | `INTEGER`       | Количество показов                          |
| `updated_at`              | `TIMESTAMPTZ`   | Время последнего пересчёта                  |

Ограничения и индексы:
- Уникальный ключ: (`campaign_id`, `date`).
- `idx_metrics_date_campaign` (`date`, `campaign_id`).
- `idx_metrics_campaign` (`campaign_id`).

---

## 3. Поток данных и агрегация

1. Источники публикуют события в Kafka (topic, например, `campaign_events`).
2. Consumer читает события, валидирует и пишет в `campaign_performance_events` (идемпотентность обязателена).
3. Плановая агрегация (например, каждые 15 минут) пересчитывает срез по `campaign_id` и `date`, складывая значения в `campaign_metric_dailies`.
4. API/дашборд читают в первую очередь из `campaign_metric_dailies`. По необходимости доступен drill‑down в сырые события.

---

## 4. Плюсы

| Плюс                  | Объяснение                                                                 |
|-----------------------|-----------------------------------------------------------------------------|
| Масштабируемость      | Kafka разгружает запись, позволяет линейно масштабировать consumption       |
| Быстрый доступ        | Предагрегированные данные доступны через один SELECT                        |
| Минимальная нагрузка  | Чтение идёт из `campaign_metric_dailies`, а не из журнала событий           |
| Гибкость              | Можно добавлять новые типы событий и метрик без пересборки схемы            |
| Историчность          | Полный журнал событий сохраняется для аудита и переагрегации                |

---

## 5. Минусы

| Минус                   | Объяснение                                                             |
|-------------------------|-------------------------------------------------------------------------|
| Сложность настройки     | Необходимы Kafka, consumer, планировщик агрегаций, кэширование         |
| Задержка агрегации      | Метрики обновляются с лагом до периода агрегации                      |
| Риск дублирования       | Нужны ключи идемпотентности на событии (например, натуральный event_id)|
| Нормализация времени    | При кросс‑таймзонных событиях требуется унификация до `TIMESTAMPTZ`    |

---

## 6. Практические замечания по миграциям

- Первичные ключи — `BIGINT` (`bigIncrements`) во всех трёх таблицах, внешние ключи — `unsignedBigInteger` с FK на `campaigns(id)`.
- Название агрегатной таблицы — `campaign_metric_dailies` (использовать именно это имя в коде).
- `ENUM` заменены на строковые поля (`VARCHAR(32)`); список допустимых значений контролируется приложением (или CHECK‑ограничениями, если включены).
- Для `campaign_metric_dailies` использовать уникальный ключ (`campaign_id`, `date`) и индексы под частые выборки.
